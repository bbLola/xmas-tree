<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åœ£è¯ç²’å­å…¨äº¤äº’ç³»ç»Ÿ</title>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { width: 100vw; height: 100vh; position: relative; }
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; justify-content: center; align-items: center;
            color: #00ffcc; z-index: 1000; transition: opacity 0.8s; pointer-events: none;
        }
        .ui-panel {
            position: absolute; bottom: 30px; left: 30px; z-index: 100;
            background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 20px;
            backdrop-filter: blur(15px); border: 1px solid rgba(0, 255, 204, 0.3); color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .btn {
            padding: 12px 24px; background: #00ffcc; border: none; border-radius: 12px;
            cursor: pointer; font-weight: bold; color: #000; margin-top: 15px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block;
        }
        .btn:hover { background: #fff; transform: scale(1.05); box-shadow: 0 0 20px #00ffcc; }
        #video-preview {
            position: absolute; top: 20px; right: 20px; width: 150px; height: 110px;
            border-radius: 15px; border: 2px solid #00ffcc; transform: scaleX(-1);
            background: #111; z-index: 100; box-shadow: 0 0 20px rgba(0,255,204,0.3);
        }
    </style>
</head>
<body>

<div id="loading-overlay">æ­£åœ¨åŒæ­¥ AI ç²’å­æ•°æ®...</div>
<div id="root"></div>
<video id="webcam" style="display:none" autoplay playsinline></video>
<canvas id="video-preview"></canvas>

<div class="ui-panel">
    <div style="font-weight: bold; font-size: 18px; margin-bottom: 5px;">ğŸ„ 3D AI åœ£è¯ç²’å­äº¤äº’ç³»ç»Ÿ</div>
    <div style="font-size: 12px; color: #00ffcc; opacity: 0.8;">ğŸ–ï¸ å¼ å¼€: æ‰©æ•£æ—‹è½¬ | âœŠ æ¡æ‹³: èšåˆæˆæ ‘ | ğŸ‘Œ æåˆ: æŠ“å–ç…§ç‰‡</div>
    <label for="img-upload" class="btn">ğŸ“‚ æ’å…¥æœ¬åœ°æ–‡æ¡£/ç…§ç‰‡</label>
    <input type="file" id="img-upload" multiple accept="image/*" style="display:none">
    <button class="btn" style="margin-left: 10px;" onclick="document.documentElement.requestFullscreen()">å…¨å±æ§åˆ¶</button>
</div>

<!-- AI æ ¸å¿ƒåº“ -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<!-- ä¿®æ­£åçš„ Import Mapï¼šè§£å†³äº† react/jsx-runtime æŠ¥é”™ -->
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
    "three": "https://esm.sh/three@0.160.0",
    "htm": "https://esm.sh/htm@3.1.1",
    "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.11?external=three,react,react-dom",
    "@react-three/drei": "https://esm.sh/@react-three/drei@9.92.7?external=three,react,react-dom"
  }
}
</script>

<script type="module">
    import React from 'react';
    import { createRoot } from 'react-dom';
    import * as THREE from 'three';
    import htm from 'htm';
    import { Canvas, useFrame } from '@react-three/fiber';
    import { OrbitControls, Environment, Float, MeshReflectorMaterial, PerspectiveCamera } from '@react-three/drei';

    const { useState, useMemo, useRef, useEffect } = React;
    const html = htm.bind(React.createElement);

    // å…¨å±€å¹³æ»‘çŠ¶æ€
    const globalState = { gesture: 'open', pinch: false, scale: 1, lastPinch: false };

    // --- æ ¸å¿ƒï¼šç²’å­å½¢çŠ¶å·¥å‚ ---
    const ParticleFactory = ({ textures }) => {
        const count = 1800;
        const meshRef = useRef();
        const dummy = new THREE.Object3D();
        const [grabbedImg, setGrabbedImg] = useState(null);

        // ç”Ÿæˆå¤šç§å‡ ä½•ä½“ (ç¤¼ç‰©ç›’ã€åœ†ç¯ã€åœ†é”¥ç­‰)
        const geometries = useMemo(() => [
            new THREE.SphereGeometry(0.2, 8, 8),
            new THREE.BoxGeometry(0.25, 0.25, 0.25),
            new THREE.TorusGeometry(0.12, 0.05, 8, 12),
            new THREE.ConeGeometry(0.2, 0.4, 4),
            new THREE.OctahedronGeometry(0.2)
        ], []);

        const particles = useMemo(() => {
            const arr = [];
            for (let i = 0; i < count; i++) {
                const t = i / count;
                const angle = i * 137.5 * (Math.PI / 180);
                const r = (1 - t) * 10;
                // æ ‘å½¢åæ ‡
                const treePos = new THREE.Vector3(
                    Math.cos(angle) * (r + Math.sin(t * 25) * 0.6),
                    t * 24 - 10,
                    Math.sin(angle) * (r + Math.sin(t * 25) * 0.6)
                );
                // æ•£å¼€åæ ‡
                const randPos = new THREE.Vector3((Math.random()-0.5)*65, (Math.random()-0.5)*65, (Math.random()-0.5)*65);
                arr.push({ treePos, randPos, curr: randPos.clone(), size: 0.3 + Math.random() * 0.5 });
            }
            return arr;
        }, []);

        useFrame((state) => {
            const time = state.clock.getElapsedTime();
            const isFist = globalState.gesture === 'fist';

            particles.forEach((p, i) => {
                let target = isFist ? p.treePos : p.randPos;
                
                // æ•£å¼€æ—¶çš„æ—‹è½¬ç®—æ³•
                if (!isFist) {
                    const rot = time * 0.2;
                    const x = p.randPos.x, z = p.randPos.z;
                    target = new THREE.Vector3(x * Math.cos(rot) - z * Math.sin(rot), p.randPos.y, x * Math.sin(rot) + z * Math.cos(rot));
                }

                p.curr.lerp(target, 0.08); // æè‡´ä¸æ»‘è¿‡æ¸¡
                dummy.position.copy(p.curr);
                dummy.scale.setScalar(p.size * globalState.scale);
                dummy.rotation.set(time * 0.5, time * 0.3, 0);
                dummy.updateMatrix();
                meshRef.current.setMatrixAt(i, dummy.matrix);
            });
            meshRef.current.instanceMatrix.needsUpdate = true;

            // æåˆæŠ“å–é€»è¾‘ (æ£€æµ‹è¾¹æ²¿è§¦å‘)
            if (globalState.pinch && !globalState.lastPinch && textures.length > 0) {
                setGrabbedImg(textures[Math.floor(Math.random() * textures.length)]);
            } else if (!globalState.pinch && grabbedImg) {
                setGrabbedImg(null);
            }
            globalState.lastPinch = globalState.pinch;
        });

        return html`
            <group>
                <instancedMesh ref=${meshRef} args=${[null, null, count]}>
                    <sphereGeometry args=${[0.2, 12, 12]} />
                    <meshStandardMaterial metalness=${1} roughness=${0.1} color="#00ffcc" envMapIntensity=${2} />
                </instancedMesh>

                ${grabbedImg && html`
                    <${Float} speed=${5} rotationIntensity=${2}>
                        <mesh position=${[0, 2, 12]}>
                            <planeGeometry args=${[8, 10]} />
                            <meshBasicMaterial map=${grabbedImg} transparent opacity=${0.9} />
                            <!-- æŠ“å–æ—¶çš„å‘å…‰æ•ˆæœ -->
                            <pointLight intensity=${250} color="#00ffcc" distance=${30} />
                        </mesh>
                    <//>
                `}
            </group>
        `;
    };

    // --- ä¸»åœºæ™¯ ---
    const SceneApp = () => {
        const [textures, setTextures] = useState([]);

        useEffect(() => {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('video-preview');
            const ctx = canvas.getContext('2d');
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6 });
            hands.onResults((res) => {
                document.getElementById('loading-overlay').style.opacity = '0';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
                
                if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    const lm = res.multiHandLandmarks[0];
                    const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    globalState.pinch = pinchDist < 0.05;
                    globalState.gesture = lm[12].y > lm[9].y ? 'fist' : 'open';
                    globalState.scale = 0.6 + (lm[0].y - lm[12].y) * 2;
                }
            });

            const cam = new Camera(video, {
                onFrame: async () => { await hands.send({ image: video }); },
                width: 480, height: 360
            });
            cam.start();

            // å›¾ç‰‡åŠ è½½
            const texLoader = new THREE.TextureLoader();
            document.getElementById('img-upload').onchange = (e) => {
                Array.from(e.target.files).forEach(f => {
                    const url = URL.createObjectURL(f);
                    texLoader.load(url, (t) => setTextures(p => [...p, t]));
                });
            };
        }, []);

        return html`
            <${Canvas} shadows>
                <${PerspectiveCamera} makeDefault position=${[0, 5, 45]} fov=${45} />
                <color attach="background" args=${['#020202']} />
                <fog attach="fog" args=${['#000', 30, 100]} />
                <ambientLight intensity=${0.4} />
                <spotLight position=${[20, 30, 10]} angle=${0.4} intensity=${200} penumbra=${1} />
                
                <!-- æ ‘é¡¶æ˜äº®ç¯æ³¡ -->
                <mesh position=${[0, 14, 0]}>
                    <sphereGeometry args=${[0.6, 32, 32]} />
                    <meshStandardMaterial emissive="#ffd700" emissiveIntensity=${15} color="#fff" />
                    <pointLight intensity=${300} color="#ffd700" distance=${50} />
                </mesh>

                <${ParticleFactory} textures=${textures} />
                <${Environment} preset="city" />

                <!-- é•œé¢åå…‰åœ°é¢ -->
                <mesh rotation=${[-Math.PI / 2, 0, 0]} position=${[0, -12, 0]}>
                    <planeGeometry args=${[120, 120]} />
                    <${MeshReflectorMaterial} 
                        blur=${[300, 100]} resolution=${1024} mixBlur=${1} mixStrength=${60}
                        roughness=${1} depthScale=${1.2} minDepthThreshold=${0.4} maxDepthThreshold=${1.4}
                        color="#080808" metalness=${0.5}
                    />
                </mesh>
                <${OrbitControls} enablePan=${false} makeDefault />
            <//>
        `;
    };

    const container = document.getElementById('root');
    createRoot(container).render(html`<${SceneApp} />`);
</script>
</body>
</html>
